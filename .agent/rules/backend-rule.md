---
trigger: always_on
---

# Backend 开发规范

## 一、架构规范

### [MUST] Drogon 框架优先原则

- 所有扩展功能的实现方案必须优先符合 Drogon 的架构设计
- 优先使用 Drogon 提供的功能模块，而不是引入三方库
- 引入三方库需在 PR 中说明必要性

### [MUST] 分层架构

- **Controller 层**：仅处理 HTTP 请求/响应，薄层化设计，不含业务逻辑
- **Plugin/Service 层**：封装核心业务逻辑，使用依赖注入（Drogon Plugin 模式）
- **Model 层**：数据访问与 ORM 映射

### [MUST] 异步编程规范

- 优先使用异步回调接口，其次同步接口，禁止使用协程接口
- 回调中使用 `shared_ptr` 延长对象生命周期
- ❌ 禁止在回调中捕获裸指针或引用（如 `[this]`、`[&var]`）

---

## 二、构建部署

### [MUST] Windows 构建流程

- 由于项目使用 Conan 管理依赖项，必须使用 `build.bat` 来编译
- `build.bat` 已配置自动清理进程，无需手动停止服务
- 使用方法：`.\build.bat [-debug|-release]`

### [MUST] 配置文件管理

- 主配置文件统一为 `config.json`
- 程序启动前会自动检查配置文件存在性
- 敏感信息（密码/密钥）应使用环境变量覆盖，禁止明文存储

---

## 三、测试规范

### [MUST] 测试前置检查

执行测试前需确认：

- [ ] 配置文件 `config.json` 存在于 exe 同级目录
- [ ] 数据库 Schema 已初始化（`init_oauth2.sql`）
- [ ] 外部服务（Redis/PostgreSQL）已启动且可达

详细检查流程参见 `/test-checklist` workflow

### [MUST] 测试分级

1. **单元测试**：每次代码变更后必须执行，通过 `ctest` 运行
2. **集成测试**：API 接口级测试，验证端到端功能
3. **浏览器集成测试**：大型 Feature 完成后执行完整 OAuth2 流程验证

### [MUST] 测试失败处理

- 重复测试出现相同错误超过 3-5 次后停止
- 分析根本原因，不要盲目重试
- 尝试不同方案解决问题

---

## 四、开发流程

### [MUST] 迭代提交规范

- 每个迭代完成后，先同步更新所有相关文档
- 然后执行 `git commit`
- 可以执行 `git commit`，但 **禁止执行 `git push`**

### [MUST] 代码质量

- 调试代码在问题解决后必须移除
- 测试通过才算完成任务
